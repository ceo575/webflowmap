// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Enums
enum Role {
  ADMIN
  STUDENT
}

enum QuestionType {
  MCQ
  TRUE_FALSE
  SHORT_ANSWER
}

enum AttemptStatus {
  IN_PROGRESS
  SUBMITTED
  EXPIRED
}

// Models

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String?
  image         String?
  grade         String?
  role          Role      @default(STUDENT)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  createdExams  Exam[]    @relation("TeacherExams")
  examResults   ExamResult[]
  weaknesses    UserWeakness[]
  practiceSessions PracticeSession[]
}

model Topic {
  id          String   @id @default(cuid())
  name        String
  description String?
  parentId    String?  // Self-relation for sub-topics
  parent      Topic?   @relation("SubTopics", fields: [parentId], references: [id])
  children    Topic[]  @relation("SubTopics")
  
  exams       Exam[]
  weaknesses  UserWeakness[]
  practiceSessions PracticeSession[]
}

model Exam {
  id            String   @id @default(cuid())
  title         String
  duration      Int      // in minutes
  grade         String?  // e.g., "12", "11"
  subject       String?  // e.g., "Math", "Physics"
  teacherId     String
  topicId       String?
  
  // New fields for exam workflow
  fullVideoUrl  String?  // Full exam solution video
  pdfUrl        String?  // PDF attachment
  tags          String?  // JSON array of tags
  classes       String?  // JSON array of class IDs
  isPublic      Boolean  @default(false)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  teacher       User     @relation("TeacherExams", fields: [teacherId], references: [id])
  topic         Topic?   @relation(fields: [topicId], references: [id])
  questions     Question[]
  results       ExamResult[]
  attempts      ExamAttempt[]
}

model Question {
  id            String       @id @default(cuid())
  examId        String
  content       String       // LaTeX supported
  type          QuestionType
  options       String?      // JSON string: options for MCQ
  correctAnswer String
  explanation   String?      // Detailed solution
  videoUrl      String?
  flowThinking  String?      // JSON string: { identify, method, execution, conclusion }
  
  // New fields for question classification
  chapter       String?      // Chapter name
  lesson        String?      // Lesson name  
  problemType   String?      // Problem type classification
  level         String?      // e.g. "NB", "TH", "VD", "VDC"
  tags          String?      // JSON string of tags
  imageBase64   String?      // Base64 encoded image (temp solution)
  
  // Relations
  exam          Exam         @relation(fields: [examId], references: [id], onDelete: Cascade)
  practiceAttempts PracticeAttempt[]
  practiceItems    PracticeSessionItem[]
}

model PracticeSession {
  id             String   @id @default(cuid())
  studentId      String
  topicId        String
  totalQuestions Int
  correctCount   Int      @default(0)
  currentIndex   Int      @default(0)
  score          Int      @default(0)
  streak         Int      @default(0)
  startedAt      DateTime @default(now())
  completedAt    DateTime?
  endedAt        DateTime?

  student        User     @relation(fields: [studentId], references: [id])
  topic          Topic    @relation(fields: [topicId], references: [id])
  attempts       PracticeAttempt[]
  items          PracticeSessionItem[]

  @@index([studentId, topicId])
}

model PracticeSessionItem {
  id         String   @id @default(cuid())
  sessionId  String
  questionId String
  orderIndex Int

  session    PracticeSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  question   Question        @relation(fields: [questionId], references: [id])

  @@unique([sessionId, questionId])
  @@unique([sessionId, orderIndex])
  @@index([questionId])
}

model PracticeAttempt {
  id              String   @id @default(cuid())
  sessionId       String
  questionId      String
  selectedAnswer  String
  isCorrect       Boolean
  answeredAt      DateTime @default(now())

  session         PracticeSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  question        Question        @relation(fields: [questionId], references: [id])

  @@unique([sessionId, questionId])
  @@index([questionId])
}

model ExamResult {
  id           String   @id @default(cuid())
  studentId    String
  examId       String
  score        Float
  maxScore     Float    @default(10)
  answers      String   // JSON string: student answers map
  aiAnalysis   String?  // AI general feedback
  chapterScore String?  // JSON string: breakdown by chapter
  startedAt    DateTime @default(now())
  completedAt  DateTime?

  // Relations
  student      User     @relation(fields: [studentId], references: [id])
  exam         Exam     @relation(fields: [examId], references: [id])
}

model UserWeakness {
  id        String   @id @default(cuid())
  userId    String
  topicId   String
  score     Float    // Competency score (0-100)
  streak    Int      @default(0)
  updatedAt DateTime @updatedAt

  // Relations
  user      User     @relation(fields: [userId], references: [id])
  topic     Topic    @relation(fields: [topicId], references: [id])

  @@unique([userId, topicId])
}

model ExamAttempt {
  id              String        @id @default(cuid())
  examId           String
  userId           String
  status           AttemptStatus @default(IN_PROGRESS)
  startedAt        DateTime      @default(now())
  submittedAt      DateTime?
  durationSeconds  Int
  score            Float?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  exam             Exam          @relation(fields: [examId], references: [id], onDelete: Cascade)
  user             User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  answers          ExamAnswer[]

  @@index([examId, userId, status])
}

model ExamAnswer {
  id          String      @id @default(cuid())
  attemptId   String
  questionId  String
  selected    Json?
  isCorrect   Boolean?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  attempt     ExamAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question    Question    @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([attemptId, questionId])
  @@index([attemptId])
}
